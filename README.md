## pw-sample — Playwright example

This repository is a compact, working Playwright + TypeScript sample that automates the Sauce Demo app.
It demonstrates recommended patterns and infra for reliable end-to-end testing:

- Page Objects (pages/)
- Global setup that can create or reuse a recorded signed-in storage state
- Allure reporting and Playwright HTML reports
- CI automation (matrix by browser, sharding and artifact upload)

---

## Quick highlights

- Playwright + TypeScript tests live in `tests/`.
- Page objects under `pages/` keep UI interaction logic centralized.
- `global-setup.ts` is resilient — in CI it will create `storage/auth.json` using secrets, while locally it will skip if storage exists or no credentials are present.
- CI runs tests across Chromium, Firefox and WebKit and shards tests for faster feedback (see `.github/workflows/playwright.yml`).

---

## Local setup (Windows PowerShell examples)

1) Install dependencies and Playwright browsers (first-time):

```powershell
npm ci
npx playwright install --with-deps
```

2) Running tests locally

- Full E2E run using credentials in environment variables (recommended when you want the global setup to work):

```powershell
$Env:SAUCE_USER='standard_user'
$Env:SAUCE_PASS='secret_sauce'
npm test
```

- Run just one browser (helps debugging):

```powershell
$Env:SAUCE_USER='standard_user'; $Env:SAUCE_PASS='secret_sauce'; npm test -- --project=chromium
```

- Run a single test shard locally (useful for reproducing shard behavior):

```powershell
$Env:SAUCE_USER='standard_user'; $Env:SAUCE_PASS='secret_sauce'; npm test -- --project=chromium --shard=1/2 --workers=2
```

- If you prefer to reuse an existing storage state (for fast local runs), place a storage file at `storage/auth.json` (CI will generate this file, but avoid committing it):

```powershell
# global-setup will detect and reuse storage/auth.json when present
npm test
```

---

## Linting & formatting

This project includes ESLint + Prettier.

- Run linting:

```powershell
npm run lint
```

- Auto-fix lint issues where possible:

```powershell
npm run lint:fix
npm run format
```

Tip: Add editor extensions for ESLint + Prettier so files are formatted on save.

---

## CI (GitHub Actions)

Workflow: `.github/workflows/playwright.yml`

- Runs on push and PRs to `main`.
- Uses a matrix to run jobs for each browser: `chromium`, `firefox`, `webkit`.
- Each browser job is sharded (two shards by default) and runs Playwright tests in parallel with multiple workers — this shortens wall-clock CI time for large suites.
- Workflow expects two secrets in your repository settings:
  - `SAUCE_USER` — (eg. `standard_user`)
  - `SAUCE_PASS` — (eg. `secret_sauce`)
- Artifacts:
  - `allure-results-<browser>-shard-<n>` — Allure raw results for each browser+shard
  - `allure-report-<browser>-shard-<n>` — Generated Allure HTML report per browser+shard (workflow will try to generate it when results exist)
  - `playwright-html-report-<browser>-shard-<n>` — Playwright HTML report (per browser+shard)

Note: The workflow fails if ESLint reports errors (lint is a blocking step). The workflow uses matrix jobs so failures are isolated to the browser/shard that failed.

---

## Allure Reporting (local)

Create the Allure report from results generated by Playwright:

```powershell
npm exec allure generate allure-results --clean -o allure-report
npm exec allure open allure-report
```

CI uploads raw `allure-results` and the generated HTML `allure-report` as artifacts — download them from the Actions UI to inspect results from any browser/shard.

---

## Safety & best practices (notes)

- Do NOT commit your `storage/auth.json` or any session tokens. The repo now ignores `storage/` — CI will create storage from secrets when needed.
- Secrets should be stored in GitHub Actions Secrets (see repo Settings → Secrets) — never put them into the repository.
- Use Playwright fixtures and `test.describe` groups for better test organization and reduced flakiness.

---

## Next steps / optional improvements

- Add `husky` + `lint-staged` pre-commit hooks to enforce lint/format on developer commits.
- Add a combined step in CI to merge Allure results from shards into a single combined report (helpful for unified reporting).
- Add test routing / labels to spread slow tests evenly across shards.

---

If you'd like I can:

- add pre-commit hooks (husky + lint-staged)
- increase the number of shards per browser (e.g., 4 shards)
- implement CI step to aggregate Allure results across shards and browsers

Feel free to tell me which of the above you want next and I'll implement it.
